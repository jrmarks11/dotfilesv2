#!/bin/bash

set -e

GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo "")

if [ -n "$GIT_ROOT" ] && [ -f "$GIT_ROOT/scripts/dev" ]; then
    PROJECT_DIR="$GIT_ROOT"
else
    PROJECT_DIR="/Users/johnmarks/Projects/bitfreighter"
fi

RUNNING_CONTAINERS=$(docker ps --format "table {{.Names}}" --no-trunc | \
    grep -v "NAMES" || true)

if [ -n "$RUNNING_CONTAINERS" ]; then
    echo "Found running containers, checking for compose stacks to stop..."

    COMPOSE_PROJECTS=$(docker ps --format "{{.Label \"com.docker.compose.project\"}}" | \
        sort -u | grep -v "^$" || true)

    for project in $COMPOSE_PROJECTS; do
        if [ -n "$project" ]; then
            CONTAINER_ID=$(docker ps -q --filter "label=com.docker.compose.project=$project" | head -1)
            COMPOSE_DIR=$(docker inspect "$CONTAINER_ID" \
                    --format '{{index .Config.Labels "com.docker.compose.project.working_dir"}}' \
                2>/dev/null || echo "")

            if [ -n "$COMPOSE_DIR" ]; then
                echo "Stopping compose stack from: $COMPOSE_DIR"
                (cd "$COMPOSE_DIR" && \
                        docker compose -f docker-compose.yml -f docker-compose.timezones.yml \
                        down --remove-orphans || \
                    docker compose down --remove-orphans || true)
            fi
        fi
    done

    docker container prune -f
fi

echo "cd $PROJECT_DIR"
cd "$PROJECT_DIR"

./scripts/dev
