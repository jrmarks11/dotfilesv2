#!/usr/bin/env bash

DOTFILES_DIR="$HOME/dotfilesv2"

# If not in dotfiles, ask to switch
if [[ "$(pwd)" != "$DOTFILES_DIR" ]]; then
    read -p "Not in dotfiles. Switch to $DOTFILES_DIR and run? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$DOTFILES_DIR" || exit 1
    else
        exit 0
    fi
fi

# Ensure we're on master
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" != "master" ]]; then
    echo "Error: Must be on master branch (currently on $current_branch)" >&2
    exit 1
fi

# Ensure working directory is clean
if [[ -n "$(git status --porcelain)" ]]; then
    echo "Error: Working directory not clean" >&2
    exit 1
fi

# Run updates
echo "Updating plugins..."
brew upgrade
brew cleanup -s
zinit update
nvim --headless "+Lazy! update" +qa
~/.tmux/plugins/tpm/bin/update_plugins all

# Check if there are changes to commit
if [[ -z "$(git status --porcelain)" ]]; then
    echo "No changes to commit"
    exit 0
fi

# Create branch, commit, merge
branch_name="update-plugins-$(date +%Y-%m-%d-%H%M%S)"
echo "Creating branch: $branch_name"

git checkout -b "$branch_name"
git add -A
git commit -m "Update plugins"
git checkout master
git merge "$branch_name" --no-edit
git branch -d "$branch_name"
git push

echo "Done! Changes merged to master and pushed."
